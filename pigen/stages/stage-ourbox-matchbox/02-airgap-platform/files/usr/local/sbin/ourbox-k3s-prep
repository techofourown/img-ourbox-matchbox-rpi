#!/usr/bin/env bash
set -euo pipefail

log(){ echo "[ourbox-k3s-prep] $*"; }

DATA_MOUNT="/var/lib/ourbox"
TOKEN_FILE="${DATA_MOUNT}/secrets/k3s_token"
CFG_DIR="/etc/rancher/k3s"
CFG="${CFG_DIR}/config.yaml"
HOSTNAME="$(hostname)"

# Hard requirement: we don't run k3s on the OS disk
if ! mountpoint -q "${DATA_MOUNT}"; then
  log "ERROR: ${DATA_MOUNT} is not mounted; refusing to start k3s."
  exit 1
fi

mkdir -p "$(dirname "${TOKEN_FILE}")" "${CFG_DIR}"

# Stable token stored on DATA disk
if [[ ! -f "${TOKEN_FILE}" ]]; then
  log "Generating k3s token: ${TOKEN_FILE}"
  head -c 32 /dev/urandom | od -An -tx1 | tr -d ' \n' > "${TOKEN_FILE}"
  chmod 0600 "${TOKEN_FILE}"
fi

# Bind to all interfaces â€” no DHCP race, no IP detection needed.
# Flannel auto-detects the right interface when flannel-iface is empty.
cat > "${CFG}" <<EOF
data-dir: /var/lib/ourbox/k3s
node-ip: "0.0.0.0"
bind-address: "0.0.0.0"
token-file: "${TOKEN_FILE}"
tls-san:
  - "127.0.0.1"
  - "${HOSTNAME}"
  - "${HOSTNAME}.local"
write-kubeconfig-mode: "0644"
EOF

log "Wrote ${CFG} (bind=0.0.0.0, tls-san includes ${HOSTNAME}.local)"
