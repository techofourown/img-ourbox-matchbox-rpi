#!/usr/bin/env bash
set -euo pipefail

log(){ echo "[$(date -Is)] $*"; }

STATE_DIR="/var/lib/ourbox/state"
MARKER="${STATE_DIR}/bootstrap.done"
KUBECONFIG_PATH="/etc/rancher/k3s/k3s.yaml"

# idempotent
if [[ -f "$MARKER" ]]; then
  exit 0
fi

# hard requirement for product posture: don't bootstrap platform onto OS disk
if ! mountpoint -q /var/lib/ourbox; then
  echo "ERROR: /var/lib/ourbox is not mounted. Refusing to bootstrap." >&2
  exit 1
fi

mkdir -p \
  "$STATE_DIR" \
  "/var/lib/ourbox/device" \
  "/var/lib/ourbox/secrets" \
  "/var/lib/ourbox/k3s/agent/images" \
  "/var/lib/ourbox/share" \
  "/var/lib/ourbox/flatnotes" \
  "/var/lib/ourbox/todo-bloom" \
  "/var/lib/ourbox/landing"

# device_id (stable)
if [[ ! -f /var/lib/ourbox/device/device_id ]]; then
  cat /proc/sys/kernel/random/uuid > /var/lib/ourbox/device/device_id
fi
DEVICE_ID="$(cat /var/lib/ourbox/device/device_id)"

log "Copying static files to DATA disk"
cp -f /opt/ourbox/airgap/platform/todo-bloom/* /var/lib/ourbox/todo-bloom/
cp -f /opt/ourbox/airgap/platform/landing/* /var/lib/ourbox/landing/

log "Hydrating airgap image tars into /var/lib/ourbox/k3s/agent/images (copy-if-missing)"
shopt -s nullglob
for tar in /opt/ourbox/airgap/k3s/*.tar /opt/ourbox/airgap/platform/images/*.tar; do
  base="$(basename "${tar}")"
  dst="/var/lib/ourbox/k3s/agent/images/${base}"
  if [[ -f "${dst}" ]]; then
    continue
  fi
  cp -f "${tar}" "${dst}"
done
shopt -u nullglob

log "Hydrated tar files:"
ls -1 /var/lib/ourbox/k3s/agent/images/*.tar 2>/dev/null || true

# Fail fast with a clear message if memory controller isn't available
if [[ -f /sys/fs/cgroup/cgroup.controllers ]] && ! grep -qw memory /sys/fs/cgroup/cgroup.controllers; then
  echo "ERROR: cgroup v2 memory controller not enabled. k3s will fail." >&2
  echo "Expected: 'memory' in /sys/fs/cgroup/cgroup.controllers" >&2
  echo "Fix: ensure /boot/firmware/cmdline.txt includes:" >&2
  echo "  cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1" >&2
  exit 1
fi

# Start k3s (enabled only after hydration prep)
systemctl enable k3s.service
systemctl start k3s.service

# Wait for kubeconfig + API (never fall back to localhost:8080)
log "Waiting for k3s kubeconfig + API..."
for i in $(seq 1 600); do
  if [[ -f "${KUBECONFIG_PATH}" ]]; then
    if /usr/local/bin/k3s kubectl --kubeconfig "${KUBECONFIG_PATH}" get nodes >/dev/null 2>&1; then
      log "k3s API is up"
      break
    fi
  fi

  # If k3s is hard-failed, exit early with useful logs
  if systemctl is-failed --quiet k3s.service; then
    echo "ERROR: k3s.service is failed. Recent logs:" >&2
    journalctl -u k3s --no-pager -n 120 >&2 || true
    exit 1
  fi

  if (( i % 10 == 0 )); then
    log "still waiting... (${i}/600)"
  fi
  sleep 1
done

# Final gate
if ! /usr/local/bin/k3s kubectl --kubeconfig "${KUBECONFIG_PATH}" get nodes >/dev/null 2>&1; then
  echo "ERROR: k3s API never became ready. Recent logs:" >&2
  journalctl -u k3s --no-pager -n 200 >&2 || true
  exit 1
fi

# Apply platform manifests (excluding ingress — Traefik CRDs may not exist yet)
log "Applying platform manifests (excluding ingress)"
for f in /opt/ourbox/airgap/platform/manifests/*.yaml; do
  [[ "$(basename "$f")" == "50-ingress.yaml" ]] && continue
  /usr/local/bin/k3s kubectl --kubeconfig "${KUBECONFIG_PATH}" apply -f "$f"
done

# Wait for Traefik IngressRoute CRD before applying ingress routes.
# If Traefik never deploys, skip ingress — core platform still works.
log "Waiting for Traefik IngressRoute CRD..."
TRAEFIK_READY=false
for i in $(seq 1 120); do
  if /usr/local/bin/k3s kubectl --kubeconfig "${KUBECONFIG_PATH}" \
      get crd ingressroutes.traefik.io >/dev/null 2>&1; then
    TRAEFIK_READY=true
    break
  fi
  if (( i % 10 == 0 )); then
    log "still waiting for CRD... (${i}/120)"
  fi
  sleep 1
done

if [[ "${TRAEFIK_READY}" == "true" ]]; then
  log "Applying ingress routes"
  /usr/local/bin/k3s kubectl --kubeconfig "${KUBECONFIG_PATH}" \
    apply -f /opt/ourbox/airgap/platform/manifests/50-ingress.yaml || \
    log "WARNING: Failed to apply ingress routes (non-fatal)"
else
  log "WARNING: Traefik CRDs not available after 120s — skipping ingress routes."
  log "Apps are still accessible via NodePort (landing page on :30080)."
fi

date -Is > "$MARKER"
echo "OurBox bootstrap complete. device_id=${DEVICE_ID}"
